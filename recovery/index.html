<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase CDN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#16a34a', // A nice green
                        secondary: '#d1d5db', // Light gray
                        dark: '#1f2937', // Dark gray
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light background */
        }
        /* Custom styles for embedded content */
        .embedded-content {
            width: 100%;
            height: 500px; /* Fixed height for consistent display, adjust as needed */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            margin-top: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f9fafb; /* bg-gray-50 */
            overflow: auto; /* For text and code to scroll */
        }
        .embedded-content iframe,
        .embedded-content img,
        .embedded-content video,
        .embedded-content audio {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; /* Ensure content fits without cropping */
            border-radius: 0.5rem;
        }
        .embedded-content pre {
            white-space: pre-wrap; /* Preserve formatting and wrap text */
            word-wrap: break-word;
            padding: 1rem;
            background-color: #1f2937; /* dark gray background for code */
            color: #f3f4f6; /* light text color */
            border-radius: 0.5rem;
            max-height: 100%;
            overflow: auto;
            width: 100%; /* Take full width within its container */
        }
        /* Loading spinner */
        .loader {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #16a34a; /* Primary green */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 bg-gray-100 text-dark">
    <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full text-center">
        <h1 class="text-3xl font-bold text-primary mb-6">Supabase CDN ðŸš€</h1>

        <div class="mb-8 p-4 border border-gray-200 rounded-lg bg-gray-50">
            <h2 class="text-xl font-semibold mb-3 text-gray-800">Upload a File</h2>
            <input type="file" id="file-input" class="block w-full text-sm text-gray-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-primary file:text-white
                hover:file:bg-green-700 cursor-pointer
                focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50"
            />
            <button id="upload-button" class="mt-4 bg-primary text-white font-bold py-2 px-6 rounded-full
                                          hover:bg-green-700 transition-colors duration-200
                                          focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50
                                          disabled:opacity-50 disabled:cursor-not-allowed">
                Upload to Storage
            </button>
            <div id="upload-status" class="mt-4 text-sm text-gray-600"></div>
            <div id="upload-progress-bar" class="w-full bg-gray-200 rounded-full h-2.5 mt-2 hidden">
                <div class="bg-primary h-2.5 rounded-full" style="width: 0%" id="progress-indicator"></div>
            </div>
            <p id="upload-error-message" class="text-red-500 font-medium mt-2"></p>
        </div>

        <hr class="my-8 border-gray-200">

        <h2 class="text-xl font-semibold mb-3 text-gray-800">View CDN File</h2>
        <div id="file-display" class="mt-4 flex flex-col items-center justify-center min-h-[300px]">
            <!-- File content will be embedded here -->
            <div id="loader" class="loader hidden"></div>
        </div>
        <p id="message" class="text-lg text-gray-600 mt-6"></p>
        <p id="error-message" class="text-red-500 font-medium mt-4"></p>

        <div class="mt-8 text-sm text-gray-500">
            <p>Powered by Supabase Storage and GitHub Pages.</p>
            <p>To view, append <code class="bg-gray-200 px-1 rounded">?fileid=your_random_id</code> to the URL.</p>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Supabase Configuration ---
        // REPLACE WITH YOUR ACTUAL SUPABASE PROJECT URL AND ANON KEY
        const SUPABASE_URL = 'https://uziorsydukhuuaraybhn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6aW9yc3lkdWtodXVhcmF5YmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MzEwMzksImV4cCI6MjA3MjAwNzAzOX0.wIj0YT9R5IggLH3nnVKjg-VCyrztyHHPsFvFFdGyypA';
        const BUCKET_NAME = 'files'; // As specified in the prompt

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const fileInput = document.getElementById('file-input');
        const uploadButton = document.getElementById('upload-button');
        const uploadStatus = document.getElementById('upload-status');
        const uploadErrorMessage = document.getElementById('upload-error-message');
        const uploadProgressBar = document.getElementById('upload-progress-bar');
        const progressIndicator = document.getElementById('progress-indicator');
        const loader = document.getElementById('loader');

        const fileDisplay = document.getElementById('file-display');
        const messageElement = document.getElementById('message');
        const errorMessage = document.getElementById('error-message');
        const fileIdFromURL = getQueryParam('fileid');

        // URL to redirect to after successful upload
        // Note: This base URL should not include the ?fileid= part, as we add it dynamically.
        const REDIRECT_BASE_URL = 'https://githubuser102234.github.io/simpleCDN/';

        /**
         * Parses the URL for a specific query parameter.
         * @param {string} param The name of the parameter to find.
         * @returns {string | null} The value of the parameter, or null if not found.
         */
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        /**
         * Displays a message on the UI for the CDN view section.
         * @param {string} msg The message to display.
         * @param {boolean} isError If true, displays as an error.
         */
        function displayCdnMessage(msg, isError = false) {
            if (isError) {
                errorMessage.innerHTML = msg; // Use innerHTML for potential links
                messageElement.textContent = '';
            } else {
                messageElement.innerHTML = msg; // Use innerHTML for potential links
                errorMessage.textContent = '';
            }
        }

        /**
         * Displays a message on the UI for the upload section.
         * @param {string} msg The message to display.
         * @param {boolean} isError If true, displays as an error.
         */
        function displayUploadMessage(msg, isError = false) {
            if (isError) {
                uploadErrorMessage.textContent = msg;
                uploadStatus.textContent = '';
            } else {
                uploadStatus.textContent = msg;
                uploadErrorMessage.textContent = '';
            }
        }

        /**
         * Updates the progress bar.
         * @param {number} percentage The percentage of upload complete (0-100).
         */
        function updateProgressBar(percentage) {
            uploadProgressBar.classList.remove('hidden');
            progressIndicator.style.width = `${percentage}%`;
            displayUploadMessage(`Uploading... ${percentage}%`);
            if (percentage === 100) {
                setTimeout(() => uploadProgressBar.classList.add('hidden'), 1000); // Hide after completion
            }
        }

        /**
         * Determines the file type based on its extension.
         * @param {string} filename The name of the file.
         * @returns {string} A category string (e.g., 'image', 'video', 'audio', 'pdf', 'text', 'office', 'unsupported').
         */
        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp', 'ico', 'tiff'];
            const videoExtensions = ['mp4', 'webm', 'ogg', 'mov', 'avi', 'mkv'];
            const audioExtensions = ['mp3', 'wav', 'ogg', 'aac', 'flac'];
            const pdfExtensions = ['pdf'];
            const officeExtensions = ['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'];
            // Expanded text/code file extensions
            const textExtensions = ['txt', 'html', 'htm', 'css', 'js', 'json', 'xml', 'md', 'csv', 'log', 'sh', 'py', 'java', 'c', 'cpp', 'h', 'php', 'rb', 'go', 'rs', 'ts', 'jsx', 'tsx', 'yml', 'yaml', 'toml', 'ini', 'cfg', 'bat', 'ps1', 'dart', 'kt', 'swift', 'r', 'pl', 'lua', 'sql'];

            if (imageExtensions.includes(ext)) return 'image';
            if (videoExtensions.includes(ext)) return 'video';
            if (audioExtensions.includes(ext)) return 'audio';
            if (pdfExtensions.includes(ext)) return 'pdf';
            if (officeExtensions.includes(ext)) return 'office';
            if (textExtensions.includes(ext)) return 'text';

            return 'unsupported';
        }

        /**
         * Embeds the file content into the display area based on its type.
         * @param {string} publicUrl The public URL of the file.
         * @param {string} originalFilename The original name of the file (to infer type).
         * @param {string | null} rawTextContent Optional: Raw text content for text files.
         */
        function embedFile(publicUrl, originalFilename, rawTextContent = null) {
            const fileCategory = getFileType(originalFilename); // Use originalFilename for type detection
            fileDisplay.innerHTML = ''; // Clear previous content
            loader.classList.add('hidden'); // Hide loader once content is ready

            const wrapper = document.createElement('div');
            wrapper.className = 'embedded-content'; // Apply common styling for embedded content

            switch (fileCategory) {
                case 'image':
                    const img = document.createElement('img');
                    img.src = publicUrl;
                    img.alt = originalFilename;
                    img.loading = 'lazy'; // Anti-lag enhancement: Lazy load images
                    wrapper.appendChild(img);
                    break;
                case 'video':
                    const video = document.createElement('video');
                    video.src = publicUrl;
                    video.controls = true;
                    video.autoplay = false;
                    video.preload = 'metadata'; // Anti-lag enhancement: Preload metadata only
                    wrapper.appendChild(video);
                    break;
                case 'audio':
                    const audio = document.createElement('audio');
                    audio.src = publicUrl;
                    audio.controls = true;
                    audio.preload = 'metadata'; // Anti-lag enhancement: Preload metadata only
                    wrapper.appendChild(audio);
                    break;
                case 'pdf':
                    const pdfIframe = document.createElement('iframe');
                    pdfIframe.src = publicUrl;
                    pdfIframe.style.width = '100%';
                    pdfIframe.style.height = '100%';
                    pdfIframe.frameBorder = '0';
                    wrapper.appendChild(pdfIframe);
                    break;
                case 'office':
                    // Use Google Docs Viewer for Office files. This requires public access.
                    // Note: Google Docs Viewer may have limitations on certain file sizes or types.
                    const officeViewerUrl = `https://docs.google.com/gview?url=${encodeURIComponent(publicUrl)}&embedded=true`;
                    const officeIframe = document.createElement('iframe');
                    officeIframe.src = officeViewerUrl;
                    officeIframe.style.width = '100%';
                    officeIframe.style.height = '100%';
                    officeIframe.frameBorder = '0';
                    officeIframe.allowFullscreen = true; // Allow fullscreen for better viewing experience
                    wrapper.appendChild(officeIframe);
                    break;
                case 'text':
                    const pre = document.createElement('pre');
                    pre.textContent = rawTextContent || 'Loading text content...'; // Show placeholder if not loaded yet
                    wrapper.appendChild(pre);
                    break;
                default:
                    const unsupportedMsg = document.createElement('p');
                    unsupportedMsg.className = 'text-red-500 font-medium p-4';
                    unsupportedMsg.textContent = `File type for "${originalFilename}" is not supported for direct embedding. You can still download it using the link above.`;
                    wrapper.appendChild(unsupportedMsg);
                    break;
            }
            fileDisplay.appendChild(wrapper);
        }

        /**
         * Fetches and displays the file from Supabase Storage using the random_id from the URL.
         * @param {string} randomIdFromUrl The random ID from the URL (e.g., from ?fileid=).
         */
        async function fetchAndDisplayFile(randomIdFromUrl) {
            displayCdnMessage(`Loading file with ID: ${randomIdFromUrl}...`);
            fileDisplay.innerHTML = ''; // Clear previous content
            loader.classList.remove('hidden'); // Show loader

            try {
                // Step 1: Query the 'files' table to get the actual storage path and original filename
                const { data: fileRecord, error: dbError } = await supabase
                    .from('files')
                    .select('*')
                    .eq('random_id', randomIdFromUrl)
                    .single();

                if (dbError || !fileRecord) {
                    displayCdnMessage(`File with ID "${randomIdFromUrl}" not found in database.`, true);
                    console.error('Database lookup error:', dbError);
                    loader.classList.add('hidden');
                    return;
                }

                const actualStoragePath = fileRecord.storage_path;
                const originalFilename = fileRecord.original_filename;

                // Step 2: Generate a public URL for the file using the actual storage path
                const { data: publicUrlData, error: publicUrlError } = supabase
                    .storage
                    .from(BUCKET_NAME)
                    .getPublicUrl(actualStoragePath);

                if (publicUrlError) {
                    displayCdnMessage(`Error generating URL for file: ${publicUrlError.message}`, true);
                    console.error('Error generating public URL:', publicUrlError);
                    loader.classList.add('hidden');
                    return;
                }

                if (!publicUrlData || !publicUrlData.publicUrl) {
                    displayCdnMessage('File not found in storage or public URL not available.', true);
                    loader.classList.add('hidden');
                    return;
                }

                const publicUrl = publicUrlData.publicUrl;
                displayCdnMessage(`File loaded: ${originalFilename}! Access it here: <a href="${publicUrl}" class="text-primary hover:underline" target="_blank">Download/View ${originalFilename}</a>`);

                const fileCategory = getFileType(originalFilename);
                if (fileCategory === 'text') {
                    // Only fetch text content for text-based files to avoid unnecessary downloads for binary files
                    const response = await fetch(publicUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const rawText = await response.text();
                    embedFile(publicUrl, originalFilename, rawText);
                } else {
                    // For other file types, directly embed using the public URL
                    embedFile(publicUrl, originalFilename);
                }

            } catch (err) {
                displayCdnMessage(`An unexpected error occurred: ${err.message}`, true);
                console.error('Unexpected error:', err);
            } finally {
                loader.classList.add('hidden'); // Ensure loader is hidden after attempt
            }
        }

        /**
         * Handles the file upload to Supabase Storage and records metadata in the database.
         */
        async function uploadFile() {
            const file = fileInput.files[0];
            if (!file) {
                displayUploadMessage('Please select a file to upload.', true);
                return;
            }

            uploadButton.disabled = true;
            displayUploadMessage('Starting upload...');
            updateProgressBar(0);
            uploadProgressBar.classList.remove('hidden');

            try {
                // Generate a unique random ID for the file
                const randomId = crypto.randomUUID();
                const originalFileName = file.name;
                const fileExtension = originalFileName.split('.').pop();
                const supabaseStoragePath = `${randomId}.${fileExtension}`; // Path in Supabase storage bucket

                // Step 1: Upload the file to Supabase Storage with the generated unique path
                const { data: storageData, error: storageError } = await supabase.storage
                    .from(BUCKET_NAME)
                    .upload(supabaseStoragePath, file, {
                        cacheControl: '3600', // Cache for 1 hour on the CDN
                        upsert: true, // Overwrite if file with same name exists (though random ID should prevent this)
                        contentType: file.type // Ensure correct content type is set
                    });

                if (storageError) {
                    displayUploadMessage(`File upload failed: ${storageError.message}`, true);
                    console.error('Supabase Storage upload error:', storageError);
                    return; // Stop if storage upload fails
                }

                updateProgressBar(50); // Indicate progress after storage upload

                // Step 2: Record file metadata in the Supabase 'files' database table
                const { data: dbData, error: dbError } = await supabase
                    .from('files')
                    .insert([
                        {
                            random_id: randomId,
                            original_filename: originalFileName,
                            mime_type: file.type,
                            storage_path: supabaseStoragePath // Store the full path used in storage
                        }
                    ]);

                if (dbError) {
                    // If DB insert fails but storage succeeded, we might have an orphaned file.
                    // Consider adding logic here to delete the uploaded file from storage if DB insert fails.
                    displayUploadMessage(`Upload completed, but metadata saving failed: ${dbError.message}. File might not be viewable.`, true);
                    console.error('Supabase Database insert error:', dbError);
                    return;
                }

                updateProgressBar(100);
                displayUploadMessage(`File "${originalFileName}" uploaded and registered successfully! Redirecting...`);
                // Anti-lag enhancement: Delay redirect slightly to ensure message is seen by the user
                setTimeout(() => {
                    // Redirect using the randomId in the URL
                    window.location.href = `${REDIRECT_BASE_URL}?fileid=${randomId}`;
                }, 1000); // 1-second delay

            } catch (err) {
                displayUploadMessage(`An unexpected error occurred during upload: ${err.message}`, true);
                console.error('Unexpected upload error:', err);
            } finally {
                uploadButton.disabled = false;
                // Ensure progress bar is hidden if upload didn't reach 100% due to an error
                if (progressIndicator.style.width !== '100%') {
                    uploadProgressBar.classList.add('hidden');
                }
            }
        }

        // --- Event Listeners ---
        uploadButton.addEventListener('click', uploadFile);

        // --- Main execution for CDN view ---
        document.addEventListener('DOMContentLoaded', () => {
            const fileId = getQueryParam('fileid');
            if (fileId) {
                fetchAndDisplayFile(fileId);
            } else {
                displayCdnMessage('Please specify a file using the <code class="bg-gray-200 px-1 rounded">?fileid=your_random_id</code> parameter in the URL or upload one above.');
                loader.classList.add('hidden'); // Hide loader if no fileId is present
            }
        });
    </script>
</body>
</html>
