<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Raw File Viewer</title>
</head>
<body>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Supabase Configuration ---
        // REPLACE WITH YOUR ACTUAL SUPABASE PROJECT URL AND ANON KEY
        const SUPABASE_URL = 'https://uziorsydukhuuaraybhn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6aW9yc3lkdWtodXVhcmF5YmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MzEwMzksImV4cCI6MjA3MjAwNzAzOX0.wIj0YT9R5IggLH3nnVKjg-VCyrztyHHPsFvFFdGyypA';
        const BUCKET_NAME = 'files';

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        /**
         * Parses the URL for a specific query parameter.
         * @param {string} param The name of the parameter to find.
         * @returns {string | null} The value of the parameter, or null if not found.
         */
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        const fileId = getQueryParam('fileid');

        if (fileId) {
            fetchRawFile(fileId);
        } else {
            console.error('No file ID specified.');
            document.body.textContent = 'Error: No file ID specified.';
        }

        /**
         * Fetches and displays the raw file from Supabase Storage.
         * @param {string} fileId The ID/path of the file in the bucket.
         */
        async function fetchRawFile(fileId) {
            try {
                // Generate a public URL for the file
                const { data, error } = supabase.storage.from(BUCKET_NAME).getPublicUrl(fileId);

                if (error || !data || !data.publicUrl) {
                    throw new Error(error ? error.message : 'File not found or public URL not available.');
                }

                const publicUrl = data.publicUrl;

                // Fetch the file content as a Blob to get the correct content type
                const response = await fetch(publicUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Create a local URL for the Blob with the correct content type
                const blob = await response.blob();
                const blobUrl = URL.createObjectURL(blob);

                // Redirect the user to the local Blob URL
                window.location.replace(blobUrl);

            } catch (err) {
                console.error('An unexpected error occurred:', err);
                document.body.textContent = `An error occurred: ${err.message}`;
            }
        }
    </script>
</body>
</html>
